<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>プレゼン評価（引数付き）</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,"Noto Sans JP","Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;margin:20px;line-height:1.5}
    .box{border:1px solid #ddd;border-radius:10px;padding:14px;margin:12px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    label{font-weight:600}
    input[type="text"], select{padding:8px;border:1px solid #ccc;border-radius:8px;min-width:240px}
    table{border-collapse:collapse;width:100%;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;vertical-align:top}
    th{background:#f7f7f7;text-align:left}
    .small{color:#666;font-size:12px}
    .btn{appearance:none;border:1px solid #333;background:#fff;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn:disabled{opacity:.5;cursor:not-allowed}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 10px;font-size:12px;color:#444}
    .err{color:#b00020;font-weight:700}
    .ok{color:#0a7a2a;font-weight:700}
    .req{color:#b00020}
    .nowrap{white-space:nowrap}
  </style>
</head>
<body>
  <h1>プレゼン評価（引数付き）</h1>
  <div class="small">
    URL例：<code>presen-eval.html?match=class-a&name=評価者A</code> ／ <code>?team=2</code> ／ <code>?target=チームB</code>
  </div>

  <div class="box">
    <div class="row">
      <div>
        <label>評価者名 <span class="req">*</span></label><br>
        <input id="evaluator" type="text" placeholder="例：林浩一" />
      </div>
      <div>
        <label>対象（チーム/学生） <span class="req">*</span></label><br>
        <input id="target" type="text" placeholder="例：チームA" />
      </div>
      <div>
        <label>マッチID（クラス等）</label><br>
        <input id="match" type="text" placeholder="例：class-a" />
      </div>
    </div>
    <div class="small" style="margin-top:8px;">
      ※URL引数があれば自動で入力されます：<span class="pill">match</span> <span class="pill">name</span> <span class="pill">target</span> <span class="pill">team</span>
    </div>
  </div>

  <div class="box">
    <div class="row" style="justify-content:space-between;">
      <div>
        <label>名簿CSV（任意）</label><br>
        <input id="csv" type="file" accept=".csv,text/csv" />
        <div class="small">ヘッダー例：「番号」「名前」。BOM/空白は自動除去。読み込むと対象選択に使えます。</div>
      </div>
      <div>
        <button class="btn" id="loadSample">サンプル対象を用意</button>
      </div>
    </div>

    <div style="margin-top:10px;">
      <label>対象選択（CSV読み込み時）</label><br>
      <select id="targetSelect">
        <option value="">（CSV未読込）</option>
      </select>
      <div class="small">選択すると「対象（チーム/学生）」に反映します。</div>
    </div>
  </div>

  <div class="box">
    <h2 style="margin-top:0;">評価入力</h2>
    <table>
      <thead>
        <tr>
          <th class="nowrap" style="width:180px;">観点</th>
          <th>評価（1〜4）</th>
        </tr>
      </thead>
      <tbody id="rubric">
        <!-- rows by JS -->
      </tbody>
    </table>

    <div style="margin-top:10px;">
      <label>良かった点</label><br>
      <textarea id="good" rows="3" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;"></textarea>
    </div>
    <div style="margin-top:10px;">
      <label>改善できる点</label><br>
      <textarea id="improve" rows="3" style="width:100%;padding:10px;border:1px solid #ccc;border-radius:10px;"></textarea>
    </div>

    <div class="row" style="margin-top:12px;">
      <button class="btn" id="register">登録（CSV出力）</button>
      <button class="btn" id="clear">入力クリア</button>
      <span id="status" class="small"></span>
    </div>
  </div>

  <div class="box">
    <h2 style="margin-top:0;">出力プレビュー</h2>
    <div class="small">登録時にこの1行がCSVとしてダウンロードされます。</div>
    <pre id="preview" style="background:#fafafa;border:1px solid #eee;border-radius:10px;padding:12px;overflow:auto;"></pre>
  </div>

<script>
(() => {
  // ===== 設定 =====
  const criteria = [
    { key: '見栄え', label: '見栄え' },
    { key: '正確さ', label: '正確さ' },
    { key: '観点1', label: '観点1' },
    { key: '観点2', label: '観点2' },
    { key: '観点3', label: '観点3' },
    { key: '観点4', label: '観点4' },
  ];

  const $ = (id) => document.getElementById(id);
  const status = (msg, kind='') => {
    const el = $('status');
    el.textContent = msg;
    el.className = 'small ' + (kind === 'err' ? 'err' : kind === 'ok' ? 'ok' : '');
  };

  // ===== URL引数反映 =====
  const qs = new URLSearchParams(location.search);
  const match = qs.get('match') ?? '';
  const name = qs.get('name') ?? '';
  const target = qs.get('target') ?? '';
  const team = qs.get('team') ?? '';

  if (match) $('match').value = match;
  if (name) $('evaluator').value = name;
  if (target) $('target').value = target;
  if (!target && team) $('target').value = 'チーム' + team;

  // ===== ルーブリック生成 =====
  const tbody = $('rubric');
  criteria.forEach((c) => {
    const tr = document.createElement('tr');
    const th = document.createElement('td');
    th.textContent = c.label;

    const td = document.createElement('td');
    const sel = document.createElement('select');
    sel.id = 'score_' + c.key;
    const opt0 = document.createElement('option');
    opt0.value = '';
    opt0.textContent = '未選択';
    sel.appendChild(opt0);
    for (let i=1;i<=4;i++) {
      const o = document.createElement('option');
      o.value = String(i);
      o.textContent = String(i);
      sel.appendChild(o);
    }
    sel.addEventListener('change', updatePreview);
    td.appendChild(sel);

    tr.appendChild(th);
    tr.appendChild(td);
    tbody.appendChild(tr);
  });

  // ===== CSV読み込み（任意） =====
  function normalizeHeader(h) {
    // remove BOM and spaces
    return (h || '').replace(/^\uFEFF/, '').replace(/\s+/g, '');
  }

  function parseCSV(text) {
    // Minimal CSV parser (handles quoted fields)
    const rows = [];
    let row = [];
    let cur = '';
    let inQ = false;
    for (let i=0;i<text.length;i++) {
      const ch = text[i];
      const next = text[i+1];
      if (inQ) {
        if (ch === '"' && next === '"') { cur += '"'; i++; }
        else if (ch === '"') { inQ = false; }
        else { cur += ch; }
      } else {
        if (ch === '"') inQ = true;
        else if (ch === ',') { row.push(cur); cur=''; }
        else if (ch === '\n') { row.push(cur); rows.push(row); row=[]; cur=''; }
        else if (ch === '\r') { /* ignore */ }
        else { cur += ch; }
      }
    }
    row.push(cur);
    rows.push(row);
    return rows.filter(r => !(r.length===1 && r[0]===''));
  }

  $('csv').addEventListener('change', async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    const text = await f.text();
    const rows = parseCSV(text);
    if (rows.length < 2) {
      status('CSVの行数が不足しています。', 'err');
      return;
    }

    const header = rows[0].map(normalizeHeader);
    const idxNo = header.findIndex(h => h === '番号');
    const idxName = header.findIndex(h => h === '名前');
    if (idxName === -1) {
      status('CSVヘッダーに「名前」列が見つかりません。', 'err');
      return;
    }

    const sel = $('targetSelect');
    sel.innerHTML = '';
    const top = document.createElement('option');
    top.value = '';
    top.textContent = '（対象を選択）';
    sel.appendChild(top);

    for (let i=1;i<rows.length;i++) {
      const r = rows[i];
      const no = idxNo >= 0 ? (r[idxNo] ?? '') : '';
      const nm = (r[idxName] ?? '').trim();
      if (!nm) continue;
      const opt = document.createElement('option');
      opt.value = nm;
      opt.textContent = no ? `${no} ${nm}` : nm;
      sel.appendChild(opt);
    }

    status('CSVを読み込みました。対象選択から反映できます。', 'ok');
  });

  $('targetSelect').addEventListener('change', (e) => {
    const v = e.target.value;
    if (v) $('target').value = v;
    updatePreview();
  });

  $('loadSample').addEventListener('click', () => {
    const sel = $('targetSelect');
    sel.innerHTML = '';
    const top = document.createElement('option');
    top.value = '';
    top.textContent = '（対象を選択）';
    sel.appendChild(top);
    ['チームA','チームB','チームC','学生 太郎','学生 花子'].forEach((nm, i) => {
      const opt = document.createElement('option');
      opt.value = nm;
      opt.textContent = `${String(i+1).padStart(2,'0')} ${nm}`;
      sel.appendChild(opt);
    });
    status('サンプル対象を用意しました。', 'ok');
  });

  // ===== 出力（1行CSV） =====
  function csvEscape(v) {
    const s = String(v ?? '');
    if (/[\",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  }

  function buildRow() {
    const now = new Date();
    const ts = now.toISOString();
    const row = {
      'タイムスタンプ': ts,
      '自分の名前': $('evaluator').value.trim(),
      '評価対象チーム': $('target').value.trim(),
    };
    criteria.forEach(c => {
      row[c.key] = $('score_' + c.key).value;
    });
    row['良かった点'] = $('good').value.trim();
    row['改善できる点'] = $('improve').value.trim();
    row['match'] = $('match').value.trim();
    return row;
  }

  function headers() {
    return ['タイムスタンプ','自分の名前','評価対象チーム', ...criteria.map(c=>c.key), '良かった点','改善できる点','match'];
  }

  function updatePreview() {
    const row = buildRow();
    const hs = headers();
    const line = hs.map(h => csvEscape(row[h])).join(',');
    const head = hs.map(h => csvEscape(h)).join(',');
    $('preview').textContent = head + '\n' + line;
  }

  $('good').addEventListener('input', updatePreview);
  $('improve').addEventListener('input', updatePreview);
  $('evaluator').addEventListener('input', updatePreview);
  $('target').addEventListener('input', updatePreview);
  $('match').addEventListener('input', updatePreview);

  $('clear').addEventListener('click', () => {
    $('good').value = '';
    $('improve').value = '';
    criteria.forEach(c => $('score_' + c.key).value = '');
    status('入力をクリアしました。');
    updatePreview();
  });

  $('register').addEventListener('click', () => {
    const ev = $('evaluator').value.trim();
    const tg = $('target').value.trim();
    if (!ev || !tg) {
      status('「評価者名」と「対象」を入力してください。', 'err');
      return;
    }

    const hs = headers();
    const row = buildRow();
    const csv = '\uFEFF' + hs.map(h => csvEscape(h)).join(',') + '\n' + hs.map(h => csvEscape(row[h])).join(',') + '\n';

    const safeMatch = ($('match').value.trim() || 'match').replace(/[^a-zA-Z0-9_-]+/g, '_');
    const safeTarget = tg.replace(/[^\p{L}\p{N}_-]+/gu, '_');
    const fname = `answer_${safeMatch}_${safeTarget}.csv`;

    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = fname;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(a.href);

    status('CSVを出力しました。', 'ok');
  });

  // 初期プレビュー
  updatePreview();
})();
</script>
</body>
</html>
