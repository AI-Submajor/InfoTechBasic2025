<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>äºˆæ¸¬çµæœ ç™ºè¡¨ï¼ˆforecastï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Hiragino Sans","Noto Sans JP",sans-serif;margin:24px;line-height:1.6;}
    h1{margin:0 0 8px;}
    .muted{color:#666;font-size:0.9rem;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;background:#fafafa;margin:14px 0;}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden;}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;}
    th{background:#f6f6f6;}
    tr:last-child td{border-bottom:none;}
    .right{text-align:right;}
    .crown{font-size:1.1rem;}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 10px;background:#fff;font-size:0.9rem;}
    .error{border:1px solid #e63946;background:#fff3f3;color:#5b0008;border-radius:12px;padding:12px;}
    input{padding:8px;border-radius:8px;border:1px solid #ddd;}
    button{padding:9px 14px;border-radius:10px;border:none;background:#0d6efd;color:#fff;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
    .chartBox{position: relative; height: 360px; background:#fff; border:1px solid #eee; border-radius:12px; padding:10px;}
    .chartBox canvas{width:100% !important; height:100% !important;}
  </style>
</head>
<body>
  <h1>äºˆæ¸¬çµæœ ç™ºè¡¨</h1>
  <div class="row muted">
    <span class="pill" id="sheetInfo">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
    <span class="pill">å‚ç…§: forecast ã‚·ãƒ¼ãƒˆ</span>
  </div>

  <div class="card">
    <div class="row">
      <label class="muted">match ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰
        <input id="matchFilter" placeholder="ä¾‹: class-aï¼ˆç©ºæ¬„ã§å…¨ä½“ï¼‰" />
      </label>
      <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
      <span class="muted" id="status"></span>
    </div>
    <div class="muted" style="margin-top:6px;">â€» forecast ã« match åˆ—ãŒç„¡ã„å ´åˆã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</div>
  </div>

  <div id="err" class="error" style="display:none"></div>

  <div class="card">
    <h2 style="margin:0 0 10px;">(1) äºˆæ¸¬å€¤ã¨å®Ÿç¸¾å€¤ï¼ˆè¡¨ï¼‰</h2>
    <div id="tableWrap"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">(2) å·®é•ï¼ˆäºˆæ¸¬âˆ’å®Ÿç¸¾ï¼‰ã®æ£’ã‚°ãƒ©ãƒ•</h2>
    <div class="chartBox"><canvas id="diffChart"></canvas></div>
    <div class="muted" style="margin-top:8px;">â€» 0 ã‚’åŸºæº–ç·šã¨ã—ã¦ã€ãƒ—ãƒ©ã‚¹/ãƒã‚¤ãƒŠã‚¹æ–¹å‘ã«æ£’ãŒä¼¸ã³ã¾ã™ï¼ˆãƒã‚¤ãƒŠã‚¹ã¯è‰²ã‚’å¤‰ãˆã¾ã™ï¼‰ã€‚</div>
  </div>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
  <script>
    // ====== è¨­å®š ======
    const SPREADSHEET_ID = '1CZWOCDTm-UJz7yyPgiPcUzMnLyja80FgCGGP6E72FQ4';
    const SHEET_NAME = 'forecast';
    const CSV_URL_BASE = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    // ====== CSV ãƒ‘ãƒ¼ã‚µï¼ˆç°¡æ˜“ãƒ»å¼•ç”¨ç¬¦å¯¾å¿œï¼‰ ======
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if(inQuotes){
          if(ch === '"' && next === '"'){ cur += '"'; i++; continue; }
          if(ch === '"'){ inQuotes = false; continue; }
          cur += ch;
        }else{
          if(ch === '"'){ inQuotes = true; continue; }
          if(ch === ','){ row.push(cur); cur=''; continue; }
          if(ch === '\n'){
            row.push(cur); cur='';
            if(row.some(v => String(v).trim() !== '')) rows.push(row);
            row = [];
            continue;
          }
          if(ch === '\r'){ continue; }
          cur += ch;
        }
      }
      row.push(cur);
      if(row.some(v => String(v).trim() !== '')) rows.push(row);
      return rows;
    }

    function normalizeHeader(h){
      return String(h ?? '').trim().replace(/^\uFEFF/, '');
    }

    function toNumber(v){
      const s = String(v ?? '').trim();
      if(!s) return NaN;
      // ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šã«ã‚‚å¯¾å¿œï¼ˆä¾‹: 1,234ï¼‰
      const n = Number(s.replace(/,/g,''));
      return Number.isFinite(n) ? n : NaN;
    }

    function showError(msg){
      const el = document.getElementById('err');
      el.style.display = '';
      el.textContent = msg;
    }
    function clearError(){
      const el = document.getElementById('err');
      el.style.display = 'none';
      el.textContent = '';
    }

    // ====== åˆ—æ¨å®šï¼ˆãƒ˜ãƒƒãƒ€è¿½å¾“ï¼‰ ======
    function inferColumns(headers){
      const find = (cands) => {
        for(const c of cands){
          const idx = headers.findIndex(h => h === c);
          if(idx >= 0) return idx;
        }
        return -1;
      };

      const teamCol = find(['ãƒãƒ¼ãƒ å','ãƒãƒ¼ãƒ ','team','Team','è©•ä¾¡å¯¾è±¡ãƒãƒ¼ãƒ ']);
      const forecastCol = find(['äºˆæ¸¬å€¤','äºˆæ¸¬','forecast','Forecast']);
      const actualCol = find(['å®Ÿç¸¾å€¤','å®Ÿç¸¾','actual','Actual']);
      const diffCol = find(['å·®é•','å·®åˆ†','diff','Diff']);
      const matchCol = headers.findIndex(h => h.toLowerCase() === 'match');

      // æœ€ä½é™: ãƒãƒ¼ãƒ åãƒ»äºˆæ¸¬å€¤ãƒ»å®Ÿç¸¾å€¤
      return { teamCol, forecastCol, actualCol, diffCol, matchCol };
    }

    function buildData(rows, matchFilter){
      if(rows.length < 2) throw new Error('forecast ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€1è¡Œï¼‹ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ï¼‰');
      const headers = rows[0].map(normalizeHeader);
      const { teamCol, forecastCol, actualCol, diffCol, matchCol } = inferColumns(headers);

      if(teamCol < 0) throw new Error('ãƒãƒ¼ãƒ åã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆä¾‹: ãƒãƒ¼ãƒ å / ãƒãƒ¼ãƒ ï¼‰ã€‚');
      if(forecastCol < 0) throw new Error('äºˆæ¸¬å€¤ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆä¾‹: äºˆæ¸¬å€¤ï¼‰ã€‚');
      if(actualCol < 0) throw new Error('å®Ÿç¸¾å€¤ã®åˆ—ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ï¼ˆä¾‹: å®Ÿç¸¾å€¤ï¼‰ã€‚');

      const data = [];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        const team = String(row[teamCol] ?? '').trim();
        if(!team) continue;

        if(matchFilter && matchCol >= 0){
          const m = String(row[matchCol] ?? '').trim();
          if(m !== matchFilter) continue;
        }

        const forecast = toNumber(row[forecastCol]);
        const actual = toNumber(row[actualCol]);
        if(!Number.isFinite(forecast) || !Number.isFinite(actual)) continue;

        let diff = Number.isFinite(toNumber(row[diffCol])) ? toNumber(row[diffCol]) : (forecast - actual);
        if(!Number.isFinite(diff)) diff = forecast - actual;

        data.push({ team, forecast, actual, diff, absDiff: Math.abs(diff) });
      }

      // å®Ÿç¸¾å€¤ã¯å…¨è¡ŒåŒã˜æƒ³å®šï¼šä»£è¡¨å€¤ã‚’æ‹¾ã†ï¼ˆæ··åœ¨ã—ã¦ã„ãŸã‚‰æœ€é »å€¤ã§è¡¨ç¤ºï¼‰
      const actualVals = data.map(d => d.actual);
      let actualValue = NaN;
      if(actualVals.length){
        const map = new Map();
        for(const v of actualVals){ map.set(v, (map.get(v) || 0) + 1); }
        actualValue = [...map.entries()].sort((a,b)=>b[1]-a[1])[0][0];
      }

      // æœ€å°çµ¶å¯¾å·®ã®å‹è€…ï¼ˆåŒç‡ã¯è¤‡æ•°ï¼‰
      let winners = new Set();
      if(data.length){
        const min = Math.min(...data.map(d => d.absDiff));
        const eps = 1e-9;
        winners = new Set(data.filter(d => Math.abs(d.absDiff - min) <= eps).map(d => d.team));
      }

      return { headers, data, winners, actualValue };
    }

    // ====== æç”» ======
    let diffChart = null;
    function destroyChart(){
      if(diffChart){ diffChart.destroy(); diffChart = null; }
    }

    function renderTable(data, winners, actualValue){
      const wrap = document.getElementById('tableWrap');
      if(!data.length){
        wrap.innerHTML = '<div class="muted">ï¼ˆè¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>';
        return;
      }

      const sorted = [...data].sort((a,b)=>a.absDiff-b.absDiff);

      const rowsHtml = sorted.map((d) => {
        const crown = winners.has(d.team) ? 'ğŸ‘‘' : '';
        return `
          <tr>
            <td>${d.team} <span class="crown">${crown}</span></td>
            <td class="right">${d.forecast.toLocaleString()}</td>
            <td class="right">${d.actual.toLocaleString()}</td>
            <td class="right">${d.diff.toLocaleString()}</td>
            <td class="right">${d.absDiff.toLocaleString()}</td>
          </tr>
        `;
      }).join('');

      const actualNote = Number.isFinite(actualValue) ? `å®Ÿç¸¾å€¤ï¼ˆå…±é€šï¼‰: ${actualValue.toLocaleString()}` : 'å®Ÿç¸¾å€¤ï¼ˆå…±é€šï¼‰: -';

      wrap.innerHTML = `
        <div class="muted" style="margin-bottom:8px;">${actualNote} / ğŸ‘‘ = |å·®é•| ãŒæœ€å°ï¼ˆåŒç‡ã¯è¤‡æ•°ï¼‰</div>
        <table>
          <thead>
            <tr>
              <th>ãƒãƒ¼ãƒ </th>
              <th class="right">äºˆæ¸¬å€¤</th>
              <th class="right">å®Ÿç¸¾å€¤</th>
              <th class="right">å·®é•ï¼ˆäºˆæ¸¬âˆ’å®Ÿç¸¾ï¼‰</th>
              <th class="right">|å·®é•|</th>
            </tr>
          </thead>
          <tbody>${rowsHtml}</tbody>
        </table>
      `;
    }

    function renderDiffChart(data){
      destroyChart();
      const ctx = document.getElementById('diffChart').getContext('2d');
      if(!data.length){
        return;
      }

      // ãƒãƒ¼ãƒ åã¯è¡¨ã¨åŒã˜é †ï¼ˆ|å·®é•| å°ã•ã„é †ï¼‰ã§ä¸¦ã¹ã‚‹
      const sorted = [...data].sort((a,b)=>a.absDiff-b.absDiff);
      const labels = sorted.map(d => d.team);
      const diffs = sorted.map(d => d.diff);

      // ãƒã‚¤ãƒŠã‚¹ã ã‘è‰²ã‚’å¤‰ãˆã‚‹ï¼ˆChart.js ã¯ data ã”ã¨ã«è‰²é…åˆ—ã‚’æ¸¡ã›ã‚‹ï¼‰
      const bg = diffs.map(v => v < 0 ? 'rgba(220,53,69,0.7)' : 'rgba(13,110,253,0.7)');
      const border = diffs.map(v => v < 0 ? 'rgba(220,53,69,1)' : 'rgba(13,110,253,1)');

      diffChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'å·®é•ï¼ˆäºˆæ¸¬âˆ’å®Ÿç¸¾ï¼‰',
            data: diffs,
            backgroundColor: bg,
            borderColor: border,
            borderWidth: 1
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: { enabled: true }
          },
          scales: {
            y: {
              beginAtZero: false,
              // 0 åŸºæº–ç·šã‚’åˆ†ã‹ã‚Šã‚„ã™ã
              grid: {
                color: (ctx) => (ctx.tick && ctx.tick.value === 0) ? 'rgba(0,0,0,0.35)' : 'rgba(0,0,0,0.08)'
              }
            }
          }
        }
      });
    }

    async function loadAndRender(){
      clearError();
      const status = document.getElementById('status');
      const btn = document.getElementById('reloadBtn');
      const matchFilter = document.getElementById('matchFilter').value.trim();

      try{
        btn.disabled = true;
        status.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';

        const url = CSV_URL_BASE + `&v=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error(`CSVå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰ã€‚ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šï¼ˆé–²è¦§å¯ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        const text = await res.text();

        const rows = parseCSV(text);
        const built = buildData(rows, matchFilter);

        document.getElementById('sheetInfo').textContent = `ãƒãƒ¼ãƒ æ•°: ${built.data.length}`;

        renderTable(built.data, built.winners, built.actualValue);
        renderDiffChart(built.data);

        status.textContent = 'å®Œäº†';
      }catch(err){
        showError(String(err && err.message ? err.message : err));
        status.textContent = 'ã‚¨ãƒ©ãƒ¼';
      }finally{
        btn.disabled = false;
      }
    }

    document.getElementById('reloadBtn').addEventListener('click', loadAndRender);
    loadAndRender();
  </script>
</body>
</html>
