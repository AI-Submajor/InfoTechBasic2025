<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>çµæœç™ºè¡¨ï¼ˆsummaryï¼‰</title>
  <style>
    body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,"Hiragino Sans","Noto Sans JP",sans-serif;margin:24px;line-height:1.6;}
    h1{margin:0 0 8px;}
    .muted{color:#666;font-size:0.9rem;}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center;}
    .card{border:1px solid #ddd;border-radius:12px;padding:14px;background:#fafafa;margin:14px 0;}
    .charts{display:grid;grid-template-columns:1fr;gap:18px;}
    .chartBox{position: relative; height: 320px;}
    .chartBox canvas{width:100% !important; height:100% !important;}
    
    
    @media (min-width: 980px){.charts{grid-template-columns:1fr 1fr;}}
    canvas{background:#fff;border:1px solid #eee;border-radius:12px;}
    table{border-collapse:collapse;width:100%;background:#fff;border:1px solid #eee;border-radius:12px;overflow:hidden;}
    th,td{border-bottom:1px solid #eee;padding:10px;text-align:left;}
    th{background:#f6f6f6;}
    tr:last-child td{border-bottom:none;}
    .right{text-align:right;}
    .crown{font-size:1.1rem;}
    .pill{display:inline-block;border:1px solid #ddd;border-radius:999px;padding:2px 10px;background:#fff;font-size:0.9rem;}
    .error{border:1px solid #e63946;background:#fff3f3;color:#5b0008;border-radius:12px;padding:12px;}
    select,input{padding:8px;border-radius:8px;border:1px solid #ddd;}
    button{padding:9px 14px;border-radius:10px;border:none;background:#0d6efd;color:#fff;cursor:pointer;}
    button:disabled{opacity:.6;cursor:not-allowed;}
  </style>
</head>
<body>
  <h1>çµæœç™ºè¡¨</h1>
  <div class="row muted">
    <span class="pill" id="sheetInfo">èª­ã¿è¾¼ã¿ä¸­â€¦</span>
    <span class="pill">å‚ç…§: summary ã‚·ãƒ¼ãƒˆ</span>
  </div>

  <div class="card">
    <div class="row">
      <label class="muted">match ã§çµã‚Šè¾¼ã¿ï¼ˆä»»æ„ï¼‰
        <input id="matchFilter" placeholder="ä¾‹: class-aï¼ˆç©ºæ¬„ã§å…¨ä½“ï¼‰" />
      </label>
      <button id="reloadBtn">å†èª­ã¿è¾¼ã¿</button>
      <span class="muted" id="status"></span>
    </div>
    <div class="muted" style="margin-top:6px;">â€» summary ã« match åˆ—ãŒç„¡ã„å ´åˆã¯ç„¡è¦–ã•ã‚Œã¾ã™ã€‚</div>
  </div>

  <div id="err" class="error" style="display:none"></div>

  <div class="card">
    <h2 style="margin:0 0 10px;">(1) è¦³ç‚¹ã”ã¨ã®å¹³å‡ç‚¹ï¼ˆãƒãƒ¼ãƒ åˆ¥æ£’ã‚°ãƒ©ãƒ•ï¼‰</h2>
    <div id="charts" class="charts"></div>
  </div>

  <div class="card">
    <h2 style="margin:0 0 10px;">(2) åˆè¨ˆç‚¹ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆæœ€é«˜å¾—ç‚¹ã«ç‹å† ï¼‰</h2>
    <div id="totals"></div>
  </div>

  <!-- Chart.js (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/chart.umd.min.js"></script>
  <script>
    // ====== è¨­å®š ======
    const SPREADSHEET_ID = '1CZWOCDTm-UJz7yyPgiPcUzMnLyja80FgCGGP6E72FQ4';
    const SHEET_NAME = 'summary';

    // gviz ã§ CSV å‡ºåŠ›ï¼ˆã‚·ãƒ¼ãƒˆãŒã€Œãƒªãƒ³ã‚¯ã‚’çŸ¥ã£ã¦ã„ã‚‹å…¨å“¡ãŒé–²è¦§å¯ã€ç­‰ã§è¦‹ãˆã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼‰
    const CSV_URL_BASE = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${encodeURIComponent(SHEET_NAME)}`;

    // ====== CSV ãƒ‘ãƒ¼ã‚µï¼ˆå¼•ç”¨ç¬¦å¯¾å¿œãƒ»æœ€ä½é™ã®å …ç‰¢æ€§ï¼‰ ======
    function parseCSV(text){
      const rows = [];
      let row = [];
      let cur = '';
      let inQuotes = false;
      for(let i=0;i<text.length;i++){
        const ch = text[i];
        const next = text[i+1];
        if(inQuotes){
          if(ch === '"' && next === '"'){ cur += '"'; i++; continue; }
          if(ch === '"'){ inQuotes = false; continue; }
          cur += ch;
        }else{
          if(ch === '"'){ inQuotes = true; continue; }
          if(ch === ','){ row.push(cur); cur=''; continue; }
          if(ch === '\n'){
            row.push(cur); cur='';
            // æœ«å°¾ã®ç©ºè¡Œã¯é™¤å¤–
            if(row.some(v => String(v).trim() !== '')) rows.push(row);
            row = [];
            continue;
          }
          if(ch === '\r'){ continue; }
          cur += ch;
        }
      }
      row.push(cur);
      if(row.some(v => String(v).trim() !== '')) rows.push(row);
      return rows;
    }

    function toNumber(v){
      const s = String(v ?? '').trim();
      if(!s) return NaN;
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function normalizeHeader(h){
      return String(h ?? '').trim().replace(/^\uFEFF/, '');
    }

    function showError(msg){
      const el = document.getElementById('err');
      el.style.display = '';
      el.textContent = msg;
    }

    function clearError(){
      const el = document.getElementById('err');
      el.style.display = 'none';
      el.textContent = '';
    }

    // ====== ãƒ‡ãƒ¼ã‚¿è§£é‡ˆï¼ˆãƒ˜ãƒƒãƒ€è¿½å¾“ï¼‰ ======
    function inferColumns(headers){
      // 1) ãƒãƒ¼ãƒ åˆ—å€™è£œ
      const teamCandidates = ['è©•ä¾¡å¯¾è±¡ãƒãƒ¼ãƒ ','ãƒãƒ¼ãƒ ','team','Team','ãƒãƒ¼ãƒ å','è©•ä¾¡ãƒãƒ¼ãƒ '];
      let teamCol = headers.findIndex(h => teamCandidates.includes(h));
      if(teamCol < 0) teamCol = 0; // æ—¢å®š: 1åˆ—ç›®

      // 2) è¦³ç‚¹åˆ—ï¼ˆè¦³ç‚¹1, è¦³ç‚¹1_å¹³å‡, è¦³ç‚¹1 å¹³å‡ ãªã©å¹…åºƒãï¼‰
      const critCols = [];
      headers.forEach((h, idx) => {
        const m = /^è¦³ç‚¹(\d+)(?:\s*[_-]?\s*(å¹³å‡|avg))?$/i.exec(h) || /^è¦³ç‚¹(\d+).*$/i.exec(h);
        if(m){
          critCols.push({ idx, n: Number(m[1]) });
        }
      });
      critCols.sort((a,b)=>a.n-b.n);

      // 3) match åˆ—ï¼ˆä»»æ„ï¼‰
      const matchCol = headers.findIndex(h => h.toLowerCase() === 'match');

      return { teamCol, critCols, matchCol };
    }

    function buildData(rows, matchFilter){
      if(rows.length < 2) throw new Error('summary ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆãƒ˜ãƒƒãƒ€1è¡Œï¼‹ãƒ‡ãƒ¼ã‚¿è¡ŒãŒå¿…è¦ï¼‰');
      const headers = rows[0].map(normalizeHeader);
      const { teamCol, critCols, matchCol } = inferColumns(headers);
      if(critCols.length === 0) throw new Error('è¦³ç‚¹åˆ—ï¼ˆè¦³ç‚¹1, è¦³ç‚¹2, ...ï¼‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚summary ã®åˆ—åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');

      const data = [];
      for(let r=1;r<rows.length;r++){
        const row = rows[r];
        const team = String(row[teamCol] ?? '').trim();
        if(!team) continue;

        if(matchFilter && matchCol >= 0){
          const m = String(row[matchCol] ?? '').trim();
          if(m !== matchFilter) continue;
        }

        const scores = critCols.map(c => toNumber(row[c.idx]));
        // NaN ãŒæ··ã˜ã‚‹è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé›†è¨ˆã‚·ãƒ¼ãƒˆã«ç©ºæ¬„ãŒã‚ã‚‹å ´åˆï¼‰
        if(scores.some(x => !Number.isFinite(x))) continue;

        const total = scores.reduce((a,b)=>a+b,0);
        data.push({ team, scores, total });
      }

      return { headers, critCols, data };
    }

    // ====== æç”» ======
    let charts = [];
    function destroyCharts(){
      charts.forEach(ch => ch.destroy());
      charts = [];
      document.getElementById('charts').innerHTML = '';
    }

    function renderCharts(critCols, data){
      const container = document.getElementById('charts');
      destroyCharts();

      const teams = data.map(d => d.team);

      critCols.forEach((c, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'card';
        wrap.style.margin = '0';

        const title = document.createElement('div');
        title.className = 'muted';
        title.style.marginBottom = '8px';
        title.textContent = `è¦³ç‚¹${c.n}ï¼šãƒãƒ¼ãƒ åˆ¥å¹³å‡ç‚¹`;
        wrap.appendChild(title);

        // Chart.js ã®ãƒªã‚µã‚¤ã‚ºç„¡é™ãƒ«ãƒ¼ãƒ—å¯¾ç­–ï¼šè¦ªè¦ç´ ã«å›ºå®šé«˜ã•ã‚’æŒãŸã›ã‚‹
        const box = document.createElement('div');
        box.className = 'chartBox';

        const canvas = document.createElement('canvas');
        box.appendChild(canvas);
        wrap.appendChild(box);
        container.appendChild(wrap);

        const values = data.map(d => d.scores[i]);

        const ch = new Chart(canvas.getContext('2d'), {
          type: 'bar',
          data: {
            labels: teams,
            datasets: [{
              label: `è¦³ç‚¹${c.n}`,
              data: values
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: { enabled: true }
            },
            scales: {
              y: { beginAtZero: true, suggestedMax: 4 }
            }
          }
        });
        charts.push(ch);
      });
    }

    function renderTotals(data){
      const root = document.getElementById('totals');
      if(data.length === 0){
        root.innerHTML = '<div class="muted">ï¼ˆè¡¨ç¤ºã§ãã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼‰</div>';
        return;
      }

      const sorted = [...data].sort((a,b)=>b.total-a.total);
      const max = sorted[0].total;
      const eps = 1e-9;
      const winners = new Set(sorted.filter(d => Math.abs(d.total - max) <= eps).map(d => d.team));

      const rows = sorted.map((d, idx) => {
        const crown = winners.has(d.team) ? 'ğŸ‘‘' : '';
        return `
          <tr>
            <td class="right">${idx+1}</td>
            <td>${d.team} <span class="crown">${crown}</span></td>
            <td class="right">${d.total.toFixed(2)}</td>
          </tr>
        `;
      }).join('');

      root.innerHTML = `
        <table>
          <thead>
            <tr>
              <th class="right">é †ä½</th>
              <th>ãƒãƒ¼ãƒ </th>
              <th class="right">åˆè¨ˆç‚¹</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
        <div class="muted" style="margin-top:8px;">â€» åˆè¨ˆç‚¹ = è¦³ç‚¹ã®å¹³å‡ç‚¹ã®å˜ç´”åˆè¨ˆï¼ˆåŒç‚¹ã¯è¤‡æ•°ã«ğŸ‘‘ï¼‰</div>
      `;
    }

    async function loadAndRender(){
      clearError();
      const status = document.getElementById('status');
      const btn = document.getElementById('reloadBtn');
      const matchFilter = document.getElementById('matchFilter').value.trim();

      try{
        btn.disabled = true;
        status.textContent = 'èª­ã¿è¾¼ã¿ä¸­â€¦';

        // cache ã‚’é¿ã‘ãŸã„å ´åˆã«å‚™ãˆã€ã‚¯ã‚¨ãƒªã§ãƒã‚¹ã‚¿ãƒ¼
        const url = CSV_URL_BASE + `&v=${Date.now()}`;
        const res = await fetch(url, { cache: 'no-store' });
        if(!res.ok) throw new Error(`CSVå–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆHTTP ${res.status}ï¼‰ã€‚ã‚·ãƒ¼ãƒˆã®å…±æœ‰è¨­å®šï¼ˆé–²è¦§å¯ï¼‰ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚`);
        const text = await res.text();

        const rows = parseCSV(text);
        const built = buildData(rows, matchFilter);

        document.getElementById('sheetInfo').textContent = `ãƒãƒ¼ãƒ æ•°: ${built.data.length} / è¦³ç‚¹æ•°: ${built.critCols.length}`;

        renderCharts(built.critCols, built.data);
        renderTotals(built.data);

        status.textContent = 'å®Œäº†';
      }catch(err){
        showError(String(err && err.message ? err.message : err));
        status.textContent = 'ã‚¨ãƒ©ãƒ¼';
      }finally{
        btn.disabled = false;
      }
    }

    document.getElementById('reloadBtn').addEventListener('click', loadAndRender);

    // åˆå›ãƒ­ãƒ¼ãƒ‰
    loadAndRender();
  </script>
</body>
</html>
